pipeline {
  agent {
    docker {
      image 'maven:3.9.6-eclipse-temurin-17'
      // OPTIMIZATION 1: Map local cache folders (.m2 and .sonar) to the container 
      // This prevents downloading the internet on every build.
      args '--user root -v /var/run/docker.sock:/var/run/docker.sock -v $HOME/.m2:/root/.m2 -v $HOME/.sonar/cache:/root/.sonar/cache'
    }
  }
  
  stages {
    stage('Checkout') {
      steps {
        echo 'Checking out code from GitHub...'
        git branch: 'main', url: 'https://github.com/nathirkasim/jenkins-pipeline.git'
      }
    }
    
    stage('Build and Package') {
      steps {
        echo 'Building the application...'
        // -DskipTests speeds up the package if tests are run by SonarQube later, 
        // otherwise remove it if you want unit tests to run here.
        sh 'mvn clean package -DskipTests' 
        echo 'Build completed successfully!'
      }
    }
    
    stage('Static Code Analysis') {
      environment {
        // OPTIMIZATION 2: Increase memory AND fix the 10-minute "Entropy" hang
        // -Djava.security.egd=file:/dev/./urandom prevents Java from blocking while waiting for randomness
        MAVEN_OPTS = "-Xmx3072m -Djava.security.egd=file:/dev/./urandom"
        SONAR_URL = "http://ec2-13-60-20-151.eu-north-1.compute.amazonaws.com:9000"
      }
      steps {
        echo 'Running SonarQube analysis...'
        withCredentials([string(credentialsId: 'sonarqube-token', variable: 'SONAR_AUTH_TOKEN')]) {
          // FIX: Used specific plugin version to remove the warning
          sh '''
            mvn org.sonarsource.scanner.maven:sonar-maven-plugin:4.0.0.4121:sonar \
              -Dsonar.plugins.downloadOnlyRequired=true \
              -Dsonar.login=$SONAR_AUTH_TOKEN \
              -Dsonar.host.url=${SONAR_URL} \
              -Dsonar.projectKey=jenkins-pipeline \
              -Dsonar.projectName=jenkins-pipeline \
              -Dsonar.java.binaries=target/classes \
              -Dsonar.exclusions=**/*.xml,**/*.css,**/*.js,**/Dockerfile,**/k8s/**
          '''
        }
        echo 'SonarQube analysis completed!'
      }
    }
    
    stage('Build Docker Image') {
      environment {
        DOCKER_IMAGE = "nathirkasim/pipe:${BUILD_NUMBER}"
      }
      steps {
        echo "Building Docker image: ${DOCKER_IMAGE}"
        script {
          // Install Docker CLI (Note: If you mount /usr/bin/docker in agent args, you can remove this block)
          sh '''
            if ! command -v docker &> /dev/null; then
                apt-get update -qq
                apt-get install -y docker.io
            fi
          '''
          sh "docker build -t ${DOCKER_IMAGE} ."
        }
        echo 'Docker image built successfully!'
      }
    }
    
    stage('Push Docker Image') {
      environment {
        DOCKER_IMAGE = "nathirkasim/pipe:${BUILD_NUMBER}"
      }
      steps {
        echo "Pushing Docker image: ${DOCKER_IMAGE}"
        script {
          withCredentials([usernamePassword(credentialsId: 'docker-cred', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
            sh '''
              echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
              docker push ${DOCKER_IMAGE}
              docker logout
            '''
          }
        }
        echo 'Docker image pushed successfully!'
      }
    }
    
    stage('Update Deployment File') {
      steps {
        echo 'Updating Kubernetes deployment file...'
        withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
          sh """
            #if git not available
            if ! command -v git &> /dev/null; then
                  apt-get update -qq
                  apt-get install -y git
              fi
            # Configure git
            git config --global user.email "nathirkasim@example.com"
            git config --global user.name "Nathir Kasim"
            
            # Update the image tag in deployment file
            sed -i 's|image: nathirkasim/pipe:.*|image: nathirkasim/pipe:${BUILD_NUMBER}|g' k8s/deployment.yaml
            
            # Check if there are changes to commit
            if git diff --quiet k8s/deployment.yaml; then
                echo "No changes to deployment file"
            else
                # Commit and push changes
                git add k8s/deployment.yaml
                git commit -m "Update deployment image to version ${BUILD_NUMBER}"
                git push https://\${GITHUB_TOKEN}@github.com/nathirkasim/jenkins-pipeline HEAD:main
                echo "Successfully updated deployment file!"
            fi
          """
        }
      }
    }
  }
  
  post {
    success {
      echo '✅ Pipeline completed successfully!'
      echo "Docker Image: nathirkasim/pipe:${BUILD_NUMBER}"
    }
    failure {
      echo '❌ Pipeline failed! Check the logs for details.'
    }
    always {
      echo 'Cleaning up workspace...'
      cleanWs()
    }
  }
}
